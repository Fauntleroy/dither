var H=Object.defineProperty,G=Object.defineProperties,K=Object.getOwnPropertyDescriptors,R=Object.getOwnPropertySymbols,Q=Object.prototype.hasOwnProperty,X=Object.prototype.propertyIsEnumerable,k=Math.pow,L=(a,t,e)=>t in a?H(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e,A=(a,t)=>{for(var e in t||(t={}))Q.call(t,e)&&L(a,e,t[e]);if(R)for(var e of R(t))X.call(t,e)&&L(a,e,t[e]);return a},S=(a,t)=>G(a,K(t)),P=(a,t,e)=>new Promise((i,o)=>{var h=l=>{try{n(e.next(l))}catch(s){o(s)}},r=l=>{try{n(e.throw(l))}catch(s){o(s)}},n=l=>l.done?i(l.value):Promise.resolve(l.value).then(h,r);n((e=e.apply(a,t)).next())});const J="GIF";function Y(a){const t=new Uint8Array(a.reduce((e,i)=>e+i.byteLength,0));return a.reduce((e,i)=>(t.set(i,e),e+i.byteLength),0),t}function Z(a,t,e){let i;if(ArrayBuffer.isView(a))i=a.buffer;else if(a instanceof ArrayBuffer)i=a;else{const o=document.createElement("canvas"),{width:h,height:r}=e||{},n=o.getContext("2d");if(!n)throw new Error("Failed to create canvas context2d");o.width=h??(typeof a.width=="number"?a.width:a.width.baseVal.value),o.height=r??(typeof a.height=="number"?a.height:a.height.baseVal.value),n.drawImage(a,0,0,o.width,o.height),i=n.getImageData(0,0,o.width,o.height).data.buffer}switch(t){case"uint8Array":return new Uint8Array(i);case"uint8ClampedArray":return new Uint8ClampedArray(i);case"dataView":return new DataView(i);default:throw new Error("Unsupported output format")}}function tt(a){const t=new Image;return t.decoding="sync",t.loading="eager",t.crossOrigin="anonymous",t.src=a,t}function et(a){return new Promise((t,e)=>{const i=tt(a);i.onload=()=>t(i),i.onerror=e})}function rt(a){const t=new Map,{workerUrl:e}=a;let{workerNumber:i=1}=a;const o=[...new Array(e?i:0)].map(()=>{try{const n=new Worker(e);return n.onmessage=h,n}catch{return null}}).filter(Boolean);i=o.length;function h(n){var l;const{id:s,data:c}=n.data;(l=t.get(s))==null||l(c),t.delete(s)}const r=function(){let n=0;return l=>o[(l??n++)%i]}();return{call:function(){let n=0;return(l,s,c,f)=>new Promise(g=>{const d=r(f);if(!d)return g(void 0);t.set(n,g),d.postMessage({id:n++,type:l,data:s},{transfer:c})})}()}}const it=typeof window<"u",m=65535,B=m*m,nt=511,O=[0,20,40,60,80,99,119,139,159,179,199,219,241,264,288,313,340,367,396,427,458,491,526,562,599,637,677,718,761,805,851,898,947,997,1048,1101,1156,1212,1270,1330,1391,1453,1517,1583,1651,1720,1790,1863,1937,2013,2090,2170,2250,2333,2418,2504,2592,2681,2773,2866,2961,3058,3157,3258,3360,3464,3570,3678,3788,3900,4014,4129,4247,4366,4488,4611,4736,4864,4993,5124,5257,5392,5530,5669,5810,5953,6099,6246,6395,6547,6700,6856,7014,7174,7335,7500,7666,7834,8004,8177,8352,8528,8708,8889,9072,9258,9445,9635,9828,10022,10219,10417,10619,10822,11028,11235,11446,11658,11873,12090,12309,12530,12754,12980,13209,13440,13673,13909,14146,14387,14629,14874,15122,15371,15623,15878,16135,16394,16656,16920,17187,17456,17727,18001,18277,18556,18837,19121,19407,19696,19987,20281,20577,20876,21177,21481,21787,22096,22407,22721,23038,23357,23678,24002,24329,24658,24990,25325,25662,26001,26344,26688,27036,27386,27739,28094,28452,28813,29176,29542,29911,30282,30656,31033,31412,31794,32179,32567,32957,33350,33745,34143,34544,34948,35355,35764,36176,36591,37008,37429,37852,38278,38706,39138,39572,40009,40449,40891,41337,41785,42236,42690,43147,43606,44069,44534,45002,45473,45947,46423,46903,47385,47871,48359,48850,49344,49841,50341,50844,51349,51858,52369,52884,53401,53921,54445,54971,55500,56032,56567,57105,57646,58190,58737,59287,59840,60396,60955,61517,62082,62650,63221,63795,64372,64952,65535],W=[0,6,13,18,22,25,28,31,34,36,38,40,42,44,46,48,50,51,53,54,56,57,59,60,61,62,64,65,66,67,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,86,87,88,89,90,91,91,92,93,94,95,95,96,97,98,98,99,100,101,101,102,103,103,104,105,106,106,107,108,108,109,110,110,111,111,112,113,113,114,115,115,116,116,117,118,118,119,119,120,121,121,122,122,123,123,124,125,125,126,126,127,127,128,128,129,129,130,130,131,132,132,133,133,134,134,135,135,136,136,137,137,138,138,139,139,140,140,140,141,141,142,142,143,143,144,144,145,145,146,146,147,147,147,148,148,149,149,150,150,151,151,151,152,152,153,153,154,154,154,155,155,156,156,156,157,157,158,158,159,159,159,160,160,161,161,161,162,162,163,163,163,164,164,165,165,165,166,166,166,167,167,168,168,168,169,169,169,170,170,171,171,171,172,172,172,173,173,174,174,174,175,175,175,176,176,176,177,177,177,178,178,179,179,179,180,180,180,181,181,181,182,182,182,183,183,183,184,184,184,185,185,185,186,186,186,187,187,187,188,188,188,189,189,189,190,190,190,191,191,191,192,192,192,193,193,193,193,194,194,194,195,195,195,196,196,196,197,197,197,198,198,198,198,199,199,199,200,200,200,201,201,201,201,202,202,202,203,203,203,204,204,204,204,205,205,205,206,206,206,206,207,207,207,208,208,208,208,209,209,209,210,210,210,210,211,211,211,212,212,212,212,213,213,213,214,214,214,214,215,215,215,215,216,216,216,217,217,217,217,218,218,218,218,219,219,219,220,220,220,220,221,221,221,221,222,222,222,222,223,223,223,224,224,224,224,225,225,225,225,226,226,226,226,227,227,227,227,228,228,228,228,229,229,229,229,230,230,230,230,231,231,231,231,232,232,232,232,233,233,233,233,234,234,234,234,235,235,235,235,236,236,236,236,237,237,237,237,238,238,238,238,239,239,239,239,239,240,240,240,240,241,241,241,241,242,242,242,242,243,243,243,243,243,244,244,244,244,245,245,245,245,246,246,246,246,246,247,247,247,247,248,248,248,248,249,249,249,249,249,250,250,250,250,251,251,251,251,251,252,252,252,252,253,253,253,253,253,254,254,254,254,255,255,255];function M(a){let t;if(a<=0)return 0;if(a>=m)return m;t=a*(a*(a+-144107)/m+132114)/m+14379;for(let e=0;e<2;e++){const i=t*t*t,o=a+(2*i+B/2)/B;t=(t*(2*a+(i+B/2)/B)+o/2)/o}return t}function I(a,t){return(a^t)<0?(a-t/2)/t:(a+t/2)/t}function q(a,t,e,i,o=!0,h=[255,255,255]){if(!o){i/=255;const r=1-i;a=a*i+r*h[0]&255,t=t*i+r*h[1]&255,e=e*i+r*h[2]&255}return{r:a,g:t,b:e}}function $(a,t,e){return a<<16|t<<8|e}function V(a,t,e){a=O[a],t=O[t],e=O[e];const i=(27015*a+35149*t+3372*e+m/2)/m,o=(13887*a+44610*t+7038*e+m/2)/m,h=(5787*a+18462*t+41286*e+m/2)/m,r=M(i),n=M(o),l=M(h);return{l:I(13792*r+52010*n-267*l,m),a:I(129628*r-159158*n+29530*l,m),b:I(1698*r+51299*n-52997*l,m)}}function D(a){if(a<=0)return 0;if(a>=m)return 255;{const t=a*nt,e=~~(t/m),i=t%m,o=W[e],h=W[e+1];return(i*(h-o)+m/2)/m+o}}function ot(a){const t=a.l+I(25974*a.a,m)+I(14143*a.b,m),e=a.l+I(-6918*a.a,m)+I(-4185*a.b,m),i=a.l+I(-5864*a.a,m)+I(-84638*a.b,m),o=k(t,3)/B,h=k(e,3)/B,r=k(i,3)/B,n=~~D((267169*o+-216771*h+15137*r+m/2)/m),l=~~D((-83127*o+171030*h+-22368*r+m/2)/m),s=~~D((-275*o+-46099*h+111909*r+m/2)/m);return{r:n,g:l,b:s}}function st(a){return new Promise(t=>{const e=new Image;e.decoding="sync",e.loading="eager",e.crossOrigin="anonymous",e.onload=()=>t(e),e.onerror=()=>t(e),e.src=a})}class E{constructor(){this.readable=new ReadableStream({start:t=>this._rsControler=t}),this.writable=new WritableStream({write:t=>P(this,null,function*(){var e,i,o,h;let r;switch(typeof t){case"string":{const n=yield st(t),l=E.ctx2d,s=l.canvas;l.clearRect(0,0,s.width,s.height),s.width=n.width,s.height=n.height,l.drawImage(n,0,0,s.width,s.height),r=l.getImageData(0,0,s.width,s.height).data;break}default:if(ArrayBuffer.isView(t))r=new Uint8ClampedArray(t.buffer);else if(t instanceof ArrayBuffer)r=new Uint8ClampedArray(t);else if(Array.isArray(t))if(Array.isArray(t[0])){const n=[];for(let l=t.length,s=0;s<l;s++)n.push((e=t[s][0])!=null?e:0,(i=t[s][1])!=null?i:0,(o=t[s][2])!=null?o:0,(h=t[s][3])!=null?h:255);r=new Uint8ClampedArray(n)}else r=new Uint8ClampedArray(t);else{const n=E.ctx2d,l=n.canvas;n.clearRect(0,0,l.width,l.height),l.width=typeof t.width=="number"?t.width:t.width.baseVal.value,l.height=typeof t.height=="number"?t.height:t.height.baseVal.value,n.drawImage(t,0,0,l.width,l.height),r=n.getImageData(0,0,l.width,l.height).data}break}this._rsControler.enqueue(r)}),close:()=>{this._rsControler.close()}})}static get ctx2d(){if(!this._ctx2d){if(!it)throw new Error("Failed to get ImageToPixels.ctx2d, not in browser.");const t=document.createElement("canvas").getContext("2d",{willReadFrequently:!0});if(!t)throw new Error("Failed to get ImageToPixels.ctx2d, getContext('2d') return null.");this._ctx2d=t}return this._ctx2d}}class N{constructor(t){this.maxColors=t,this.readable=new ReadableStream({start:e=>this._rsControler=e}),this.writable=new WritableStream({write:e=>{this._rsControler.enqueue(this._boxesToQuantizedColors(this._colorsToBoxes(e)))},close:()=>{this._rsControler.close()}})}static createSorter(t){const e=t[0],i=t[1],o=t[2];return(h,r)=>h.lab[e]-r.lab[e]||h.lab[i]-r.lab[i]||h.lab[o]-r.lab[o]}_colorsToBoxes(t){let e={start:0,end:t.length-1,sorted:null,count:0,score:0,weight:0,sort:"lab",avg:{l:0,a:0,b:0}};const i=[e];let o=1;const h=(s,c,f)=>s>=c?c>=f?"lab":s>=f?"lba":"bla":s>=f?"alb":c>=f?"abl":"bal",r=s=>{const{start:c,end:f}=s;s.count=f-c+1,s.weight=0;const g={l:0,a:0,b:0};for(let w=c;w<=f;w++){const u=t[w];g.l+=u.lab.l*u.count,g.a+=u.lab.a*u.count,g.b+=u.lab.b*u.count,s.weight+=u.count}s.avg.l=g.l/s.weight,s.avg.a=g.a/s.weight,s.avg.b=g.b/s.weight;const d={l:0,a:0,b:0};for(let w=c;w<=f;w++){const u=t[w];d.l+=k(u.lab.l-s.avg.l,2)*u.count,d.a+=k(u.lab.a-s.avg.a,2)*u.count,d.b+=k(u.lab.b-s.avg.b,2)*u.count}s.sort=h(d.l,d.a,d.b),s.score=Math.max(d.l,d.a,d.b)},n=(s,c)=>{const f={start:c+1,end:s.end,sorted:s.sorted,count:0,score:0,weight:0,sort:"lab",avg:{l:0,a:0,b:0}};r(f),s.end-=f.count,r(s),i.push(f),o++},l=()=>{let s=-1,c=-1;if(o===this.maxColors)return-1;for(let f=0;f<o;f++){const g=i[f];g.count>=2&&g.score>c&&(s=f,c=g.score)}return s};for(r(e);e&&e.count>1;){const{start:s,end:c,sort:f,sorted:g}=e;if(f!==g){const y=t.slice(s,c+1).sort(N.createSorter(f));for(let v=y.length,C=0;C<v;C++)t[s+C]=y[C];e.sorted=f}const d=e.weight+1>>1;let w=s,u=0;for(;w<c-1&&(u+=t[w].count,!(u>d));w++);n(e,w);const b=l();e=b>=0?i[b]:null}return i}_boxesToQuantizedColors(t){const e=t.reduce((i,o)=>i+o.weight,0);return t.map(i=>{const{r:o,g:h,b:r}=ot(i.avg);return{rgbInt:$(o,h,r),rgb:{r:o,g:h,b:r},hex:`#${o.toString(16).padStart(2,"0")}${h.toString(16).padStart(2,"0")}${r.toString(16).padStart(2,"0")}`,lab:i.avg,count:i.weight,percentage:i.weight/e}}).sort((i,o)=>i.rgbInt-o.rgbInt)}}class at{constructor(t,e,i){this.statsMode=t,this.premultipliedAlpha=e,this.tint=i,this._colors=[],this._cache=new Map,this.readable=new ReadableStream({start:o=>this._rsControler=o}),this.writable=new WritableStream({write:o=>{for(let h=o.length,r=0;r<h;r+=4){let n=o[r],l=o[r+1],s=o[r+2];const c=o[r+3];if(this.statsMode==="diff"&&this._previousPixels&&n===this._previousPixels[r]&&l===this._previousPixels[r+1]&&s===this._previousPixels[r+2]&&c===this._previousPixels[r+3])continue;({r:n,g:l,b:s}=q(n,l,s,c,this.premultipliedAlpha,this.tint));const f=$(n,l,s),g={rgbInt:f,lab:V(n,l,s),count:1},d=f%32768;let w=this._cache.get(d);w||this._cache.set(d,w=new Map);let u=w.get(f);if(u!==void 0){this._colors[u].count++;continue}u=this._colors.push(g)-1,w.set(f,u)}this.statsMode==="diff"&&(this._previousPixels=o)},close:()=>{this._rsControler.enqueue(this._colors.slice()),this._rsControler.close(),this._colors.length=0,this._cache.clear(),this._previousPixels=void 0}})}}class z{constructor(t=[],e=!1,i=[255,255,255]){this._premultipliedAlpha=e,this._tint=i,this._cache=new Map,this._colorMap=[],t.length&&this.setup(t)}setup(t){t=t.sort((r,n)=>r.rgbInt-n.rgbInt),this._cache.clear();const e=[],i=new Map;for(let r=-1,n=t.length,l=0;l<n;l++){const{rgbInt:s}=t[l];if(s===r){i.set(l,!0);continue}r=s}h({min:[-65535,-65535,-65535],max:[65535,65535,65535]}),this._colorMap=e;function o(r){const n={min:[65535,65535,65535],max:[-65535,-65535,-65535]},l=[];for(let w=t.length,u=0;u<w;u++){const{lab:b}=t[u];i.has(u)||b.l<r.min[0]||b.a<r.min[1]||b.b<r.min[2]||b.l>r.max[0]||b.a>r.max[1]||b.b>r.max[2]||(b.l<n.min[0]&&(n.min[0]=b.l),b.a<n.min[1]&&(n.min[1]=b.a),b.b<n.min[2]&&(n.min[2]=b.b),b.l>n.max[0]&&(n.max[0]=b.l),b.a>n.max[1]&&(n.max[1]=b.a),b.b>n.max[2]&&(n.max[2]=b.b),l.push({lab:b,index:u}))}let s="l",c=0;if(!l.length)return{index:-1,longest:s,longestIndex:c};const f=n.max[0]-n.min[0],g=n.max[1]-n.min[1],d=n.max[2]-n.min[2];return d>=f&&d>=g&&(s="b",c=2),g>=f&&g>=d&&(s="a",c=1),f>=g&&f>=d&&(s="l",c=0),{index:l.sort((w,u)=>w.lab[s]-u.lab[s])[l.length>>1].index,longest:s,longestIndex:c}}function h(r){const{index:n,longest:l,longestIndex:s}=o(r);if(n<0)return-1;i.set(n,!0);const{lab:c}=t[n],f={left:0,right:0,longest:l,lab:c,index:n},g=e.push(f)-1,d={max:[...r.max],min:[...r.min]},w={max:[...r.max],min:[...r.min]};d.max[s]=c[l],w.min[s]=Math.min(c[l]+1,65535);const u=h(d);let b=-1;return w.min[s]<=w.max[s]&&(b=h(w)),f.left=u,f.right=b,g}}_colormapNearestNode(t,e,i){const{left:o,right:h,longest:r,lab:n,index:l}=this._colorMap[t],s=Math.min(k(e.l-n.l,2)+k(e.a-n.a,2)+k(e.b-n.b,2),4294967294);s<i.dist&&(i.index=l,i.dist=s);let c,f;if(o!==-1||h!==-1){const g=e[r]-n[r];g<=0?(c=o,f=h):(c=h,f=o),c!==-1&&this._colormapNearestNode(c,e,i),f!==-1&&k(g,2)<i.dist&&this._colormapNearestNode(f,e,i)}}findNearestIndex(t,e,i,o=255){({r:t,g:e,b:i}=q(t,e,i,o,this._premultipliedAlpha,this._tint));const h=$(t,e,i),r=h%32768;let n=this._cache.get(r);n||this._cache.set(r,n=new Map);let l=n.get(h);if(l!==void 0)return l;const s={dist:Number.MAX_SAFE_INTEGER,index:-1};return this._colormapNearestNode(0,V(t,e,i),s),l=s.index,n.set(h,l),l}}class lt{constructor(t={}){this.colors=[],this.config=this._resolveOptions(t),this._stream=this._createStream()}_resolveOptions(t){const{maxColors:e=256,statsMode:i="full",algorithm:o="median-cut",premultipliedAlpha:h=!1,tint:r=[255,255,255],samples:n=[]}=t;return{maxColors:e,statsMode:i,algorithm:o,premultipliedAlpha:h,tint:r,samples:n}}_createStream(){let t;switch(this.config.algorithm){case"median-cut":default:t=new N(this.config.maxColors);break}return new ReadableStream({start:e=>{this._streamControler=e,this.config.samples.forEach(i=>e.enqueue(i))}}).pipeThrough(new E).pipeThrough(new at(this.config.statsMode,this.config.premultipliedAlpha,this.config.tint)).pipeThrough(t)}addSample(t){this._streamControler.enqueue(t)}generate(){return new Promise(t=>{this._streamControler.close(),this._stream.pipeTo(new WritableStream({write:e=>{this.colors=e,this.finder=new z(e,this.config.premultipliedAlpha,this.config.tint),this._stream=this._createStream(),t(e)}}))})}match(t){var e;let i;if(typeof t=="number")i=[t>>24&255,t>>16&255,t>>8&255,t&255];else if(typeof t=="string"){const r=t.replace(/^#/,"");i=[`${r[0]}${r[1]}`,`${r[2]}${r[3]}`,`${r[4]}${r[5]}`].map(n=>parseInt(n,16))}else if(Array.isArray(t))i=t;else throw new TypeError("Unsupported color format");const o=(e=this.finder)==null?void 0:e.findNearestIndex(i[0],i[1],i[2],i[3]);if(o===void 0||o<0)return;const h=this.colors[o];if(h)return{color:h,index:o}}toColors(){return this.colors.slice()}toHexColors(){return this.colors.map(t=>t.hex)}toRgbColors(){return this.colors.map(t=>t.rgb)}toRgbIntColors(){return this.colors.map(t=>t.rgbInt)}toLabColors(){return this.colors.map(t=>t.lab)}toUint8Array(t=this.colors.length*4){var e,i;let o;const h=new Uint8ClampedArray(t);for(let r=0;r<t;r++){const n=r*4,l=(e=(i=this.colors[r])==null?void 0:i.rgb)!=null?e:o;l&&(h[n]=l.r,h[n+1]=l.g,h[n+2]=l.b,h[n+3]=255,o=l)}return h}clear(){this.colors.length=0,this._stream=this._createStream()}}const U=class{constructor(a=!0){this.isDebug=a}time(a){this.isDebug&&console.time(`${U.prefix} ${a}`)}timeEnd(a){this.isDebug&&console.timeEnd(`${U.prefix} ${a}`)}debug(...a){this.isDebug&&console.debug(U.prefix,...a)}warn(...a){this.isDebug&&console.warn(U.prefix,...a)}};let F=U;F.prefix="[modern-gif]";class ht{constructor(t){this._config=t,this._frames=[],this.readable=new ReadableStream({start:e=>this._rsControler=e}),this.writable=new WritableStream({write:e=>{this._frames.push(e)},close:()=>{const e=this._config.backgroundColorIndex;let i;this._frames.forEach((o,h)=>{var r,n;const{width:l=1,height:s=1,data:c}=o,f=o.transparent||((n=(r=this._frames[h+1])==null?void 0:r.transparent)!=null?n:!0);let g=0,d=0,w=l-1,u=s-1,b;if(f){for(;d<u;){let _=!0;for(let p=0;p<l;p++)if(c[l*d+p]!==e){_=!1;break}if(!_)break;d++}for(;u>d;){let _=!0;for(let p=0;p<l;p++)if(c[l*u+p]!==e){_=!1;break}if(!_)break;u--}for(;g<w;){let _=!0;for(let p=d;p<u;p++)if(c[l*p+g]!==e){_=!1;break}if(!_)break;g++}for(;w>g;){let _=!0;for(let p=d;p<u;p++)if(c[l*p+w]!==e){_=!1;break}if(!_)break;w--}}else{if(i){for(;d<u;){let _=!0;for(let p=0;p<l;p++){const x=l*d+p;if(c[x]!==i[x]){_=!1;break}}if(!_)break;d++}for(;u>d;){let _=!0;for(let p=0;p<l;p++){const x=l*u+p;if(c[x]!==i[x]){_=!1;break}}if(!_)break;u--}if(d===u)g=w;else{for(;g<w;){let _=!0;for(let p=d;p<=u;p++){const x=p*l+g;if(c[x]!==i[x]){_=!1;break}}if(!_)break;g++}for(;w>g;){let _=!0;for(let p=d;p<=u;p++){const x=p*l+w;if(c[x]!==i[x]){_=!1;break}}if(!_)break;w--}}}b=i,i=c}const y=w+1-g,v=u+1-d,C=new Uint8ClampedArray(y*v);for(let _=0;_<v;_++)for(let p=0;p<y;p++){const x=_*y+p,T=(d+_)*l+(g+p);if(!f&&b&&c[T]===b[T]){C[x]=e;continue}C[x]=c[T]}this._rsControler.enqueue(S(A({},o),{left:g,top:d,width:y,height:v,disposal:f?2:1,data:C,graphicControl:S(A({},o.graphicControl),{transparent:!0,transparentIndex:e})}))}),this._rsControler.close()}})}}class j{constructor(t=4096){this._chunkByteLength=t,this._chunkIndex=0,this._chunkOffset=0,this._chunks=[this._createChunk()]}get cursor(){return[this._chunkIndex,this._chunkOffset]}_createChunk(){return new DataView(new ArrayBuffer(this._chunkByteLength))}writeByte(t,e){e?this._chunks[e[0]].setUint8(e[1],t):(this._chunkOffset>=this._chunkByteLength&&(this._chunks[++this._chunkIndex]=this._createChunk(),this._chunkOffset=0),this._chunks[this._chunkIndex].setUint8(this._chunkOffset++,t))}writeBytes(t){t.forEach(e=>this.writeByte(e))}writeString(t){t.split("").forEach(e=>{this.writeByte(e.charCodeAt(0))})}writeUnsigned(t){this.writeBytes([t&255,t>>8&255])}calculateDistance(t){return this._chunkIndex*this._chunkByteLength+this._chunkOffset-(t[0]*this._chunkByteLength+t[1])}toUint8Array(){this._chunks[this._chunkIndex]=new DataView(this._chunks[this._chunkIndex].buffer.slice(0,this._chunkOffset));const t=new Uint8Array(this._chunks.reduce((i,o)=>i+o.byteLength,0));let e=0;return this._chunks.forEach(i=>{t.set(new Uint8Array(i.buffer),e),e+=i.byteLength}),this._chunks=[this._createChunk()],this._chunkIndex=0,this._chunkOffset=0,t}}class ct{constructor(t){this._config=t,this._frames=[],this.readable=new ReadableStream({start:e=>this._rsControler=e}),this.writable=new WritableStream({write:e=>{this._frames.push(e)},close:()=>{const e=this._encodeHeader(),i=Y(this._frames),o=new Uint8Array(e.length+i.byteLength+1);o.set(e),o.set(i,e.byteLength),o[o.length-1]=59,this._rsControler.enqueue(o),this._rsControler.close(),this._frames.length=0}})}_encodeHeader(){var t,e,i;const o=A({version:"89a",looped:!0,loopCount:0,pixelAspectRatio:0},this._config);if(o.width<=0||o.width>65535)throw new Error("Width invalid.");if(o.height<=0||o.height>65535)throw new Error("Height invalid.");let h=0;if((t=o.colorTable)!=null&&t.length){let n=o.colorTable.length;if(n<2||n>256||n&n-1)throw new Error("Invalid color table length, must be power of 2 and 2 .. 256.");for(;n>>=1;)++h;if(n=1<<h,o.colorTableSize=--h,o.backgroundColorIndex>=n)throw new Error("Background index out of range.");if(o.backgroundColorIndex===0)throw new Error("Background index explicitly passed as 0.")}const r=new j;return r.writeString(J),r.writeString(o.version),r.writeUnsigned(o.width),r.writeUnsigned(o.height),r.writeByte(parseInt(`${o.colorTableSize?1:0}1110${o.colorTableSize.toString(2).padStart(3,"0")}`,2)),r.writeByte(o.backgroundColorIndex),r.writeByte(o.pixelAspectRatio),r.writeBytes((i=(e=o.colorTable)==null?void 0:e.flat())!=null?i:[]),o.looped&&(r.writeByte(33),r.writeByte(255),r.writeByte(11),r.writeString("NETSCAPE2.0"),r.writeByte(3),r.writeByte(1),r.writeUnsigned(o.loopCount),r.writeByte(0)),r.toUint8Array()}}class ut{constructor(t,e){this._config=t,this.readable=new ReadableStream({start:i=>this._rsControler=i}),this.writable=new WritableStream({write:i=>{const o=this._config.backgroundColorIndex,h=i.data;let r=!1;const n=new Uint8ClampedArray(h.length/4);for(let l=h.length,s=0;s<l;s+=4)h[s+3]===0?(n[s/4]=o,r=!0):n[s/4]=this._finder.findNearestIndex(h[s],h[s+1],h[s+2],h[s+3]);this._rsControler.enqueue(S(A({},i),{data:n,transparent:r}))},close:()=>{this._rsControler.close()}}),this._finder=new z(e,t.premultipliedAlpha,t.tint)}}function dt(a,t,e){e.writeByte(a);let i=e.cursor;e.writeByte(0);const o=1<<a,h=o-1,r=o+1;let n=r+1,l=a+1,s=0,c=0;function f(v){for(;s>=v;)e.writeByte(c&255),c>>=8,s-=8,e.calculateDistance(i)===256&&(e.writeByte(255,i),i=e.cursor,e.writeByte(0))}function g(v){c|=v<<s,s+=l,f(8)}let d=t[0]&h,w={},u,b,y;g(o);for(let v=t.length,C=1;C<v;++C)if(y=t[C]&h,u=d<<8|y,b=w[u],b===void 0){for(c|=d<<s,s+=l;s>=8;)e.writeByte(c&255),c>>=8,s-=8,e.calculateDistance(i)===256&&(e.writeByte(255,i),i=e.cursor,e.writeByte(0));n===4096?(g(o),n=r+1,l=a+1,w={}):(n>=1<<l&&++l,w[u]=n++),d=y}else d=b;g(d),g(r),f(1),e.calculateDistance(i)===1?e.writeByte(0,i):(e.writeByte(e.calculateDistance(i)-1,i),e.writeByte(0))}class ft{constructor(t){this._config=t,this.readable=new ReadableStream({start:e=>this._rsControler=e}),this.writable=new WritableStream({write:e=>{var i,o,h;const r=new j,{left:n=0,top:l=0,width:s=0,height:c=0,delay:f=100,colorTable:g}=e;let{disposal:d=0}=e;const w=(i=e.graphicControl)==null?void 0:i.transparent;let u=(h=(o=e.graphicControl)==null?void 0:o.transparentIndex)!=null?h:255;if(n<0||n>65535)throw new Error("Left invalid.");if(l<0||l>65535)throw new Error("Top invalid.");if(s<=0||s>65535)throw new Error("Width invalid.");if(c<=0||c>65535)throw new Error("Height invalid.");let b=8,y=g?g.length:0;if(y){if(y<2||y>256||y&y-1)throw new Error("Invalid color table length, must be power of 2 and 2 .. 256.");for(;y>>=1;)++b}r.writeByte(33),r.writeByte(249),r.writeByte(4),w?d||(d=2):u=0,r.writeByte(parseInt(`000${Number(d&7).toString(2).padStart(3,"0")}0${w?1:0}`,2)),r.writeUnsigned(f/10),r.writeByte(u),r.writeByte(0),r.writeByte(44),r.writeUnsigned(n),r.writeUnsigned(l),r.writeUnsigned(s),r.writeUnsigned(c),g!=null&&g.length?(r.writeByte(parseInt(`10000${(b-1).toString(2).padStart(3,"0")}`,2)),r.writeBytes(g.flat())):r.writeByte(0),dt(b,e.data,r),this._rsControler.enqueue(r.toUint8Array())},close:()=>this._rsControler.close()})}}class gt{constructor(t){var e;this._encodingFrames=[],this._encodeUUID=0,this._logger=new F(!!t.debug),this._config=this._resolveOptions(t),this._palette=new lt({maxColors:this._config.maxColors,premultipliedAlpha:this._config.premultipliedAlpha,tint:this._config.tint}),this._config.workerUrl?(this._worker=rt({workerUrl:this._config.workerUrl}),this._worker.call("encoder:init",t)):(e=this._config.frames)==null||e.forEach(i=>this.encode(i))}_resolveOptions(t){["width","height"].forEach(n=>{typeof t[n]<"u"&&Math.floor(t[n])!==t[n]&&(console.warn(`${n} cannot be a floating point number`),t[n]=Math.floor(t[n]))});const{colorTableSize:e=256,backgroundColorIndex:i=e-1,maxColors:o=e-1,premultipliedAlpha:h=!1,tint:r=[255,255,255]}=t;return S(A({},t),{colorTableSize:e,backgroundColorIndex:i,maxColors:o,premultipliedAlpha:h,tint:r})}encode(t){return P(this,null,function*(){if(this._worker){let r;return ArrayBuffer.isView(t.data)?r=[t.data.buffer]:t.data instanceof ArrayBuffer&&(r=[t.data]),this._worker.call("encoder:encode",t,r)}const e=this._encodeUUID;this._encodeUUID++;const{width:i=this._config.width,height:o=this._config.height}=t;let{data:h}=t;try{this._logger.time(`palette:sample-${e}`),h=typeof h=="string"?yield et(h):h,h=Z(h,"uint8ClampedArray",{width:i,height:o}),this._encodingFrames.push(S(A({},t),{width:i,height:o,data:h})),this._palette.addSample(h)}finally{this._logger.timeEnd(`palette:sample-${e}`)}})}flush(t){return P(this,null,function*(){if(this._worker)return this._worker.call("encoder:flush",t);this._logger.time("palette:generate");const e=yield this._palette.generate();this._logger.timeEnd("palette:generate");const i=e.map(h=>[h.rgb.r,h.rgb.g,h.rgb.b]);for(;i.length<this._config.colorTableSize;)i.push([0,0,0]);this._logger.debug("palette:maxColors",this._config.maxColors),this._logger.isDebug&&console.debug(e.map(()=>"%c ").join(""),...e.map(h=>`margin: 1px; background: ${h.hex}`)),this._logger.time("encode");const o=yield new Promise(h=>{new ReadableStream({start:r=>{this._encodingFrames.forEach(n=>{r.enqueue(n)}),r.close()}}).pipeThrough(new ut(this._config,e)).pipeThrough(new ht(this._config)).pipeThrough(new ft(this._config)).pipeThrough(new ct(S(A({},this._config),{colorTable:i}))).pipeTo(new WritableStream({write:r=>h(r)}))});switch(this._logger.timeEnd("encode"),this._encodingFrames=[],this._encodeUUID=0,t){case"blob":return new Blob([o.buffer],{type:"image/gif"});case"arrayBuffer":default:return o.buffer}})}}function wt(a){return new gt(a).flush(a.format)}export{gt as Encoder,wt as encode};
