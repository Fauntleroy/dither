var Ge=Object.defineProperty,Ze=Object.defineProperties;var Ve=Object.getOwnPropertyDescriptors;var xe=Object.getOwnPropertySymbols;var qe=Object.prototype.hasOwnProperty,je=Object.prototype.propertyIsEnumerable;var k=Math.pow,ye=(E,C,S)=>C in E?Ge(E,C,{enumerable:!0,configurable:!0,writable:!0,value:S}):E[C]=S,U=(E,C)=>{for(var S in C||(C={}))qe.call(C,S)&&ye(E,S,C[S]);if(xe)for(var S of xe(C))je.call(C,S)&&ye(E,S,C[S]);return E},R=(E,C)=>Ze(E,Ve(C));var H=(E,C,S)=>new Promise((ae,q)=>{var le=v=>{try{K(S.next(v))}catch(G){q(G)}},ce=v=>{try{K(S.throw(v))}catch(G){q(G)}},K=v=>v.done?ae(v.value):Promise.resolve(v.value).then(le,ce);K((S=S.apply(E,C)).next())});(function(){"use strict";const E="GIF",C=["87a","89a"];function he(h){const e=new Uint8Array(h.reduce((t,r)=>t+r.byteLength,0));return h.reduce((t,r)=>(e.set(r,t),t+r.byteLength),0),e}function j(h,e,t){let r;if(ArrayBuffer.isView(h))r=h.buffer;else if(h instanceof ArrayBuffer)r=h;else{const a=document.createElement("canvas"),{width:c,height:n}=t||{},o=a.getContext("2d");if(!o)throw new Error("Failed to create canvas context2d");a.width=c!=null?c:typeof h.width=="number"?h.width:h.width.baseVal.value,a.height=n!=null?n:typeof h.height=="number"?h.height:h.height.baseVal.value,o.drawImage(h,0,0,a.width,a.height),r=o.getImageData(0,0,a.width,a.height).data.buffer}switch(e){case"uint8Array":return new Uint8Array(r);case"uint8ClampedArray":return new Uint8ClampedArray(r);case"dataView":return new DataView(r);default:throw new Error("Unsupported output format")}}function Ie(h){const e=new Image;return e.decoding="sync",e.loading="eager",e.crossOrigin="anonymous",e.src=h,e}function Ce(h){return new Promise((e,t)=>{const r=Ie(h);r.onload=()=>e(r),r.onerror=t})}class Se{constructor(e){this.offset=0,this._view=j(e,"dataView")}readByte(){return this._view.getUint8(this.offset++)}readBytes(e){return Array.from({length:e}).map(()=>this.readByte())}readString(e){return String.fromCharCode(...this.readBytes(e))}readUnsigned(){return[this._view.getUint16(this.offset,!0),this.offset+=2][0]}readBits(){return this._view.getUint8(this.offset++).toString(2).padStart(8,"0").split("").map(Number)}readColorTable(e){return Array.from({length:e},()=>Array.from(this.readBytes(3)))}readSubBlock(){const e=[];for(;;){const t=this.readByte();if(t===0&&this._view.getUint8(this.offset)!==0)break;e.push(t)}return e}}function Te(h){const e={},t=new Se(h),r=()=>({index:0,delay:100,disposal:0}),a=t.readString(3),c=t.readString(3);if(a!==E||!C.includes(c))throw new Error("This is not a 87a/89a GIF data.");e.version=c,e.width=t.readUnsigned(),e.height=t.readUnsigned();const n=t.readBits();e.globalColorTable=!!n[0],e.colorResoluTion=parseInt(n.slice(1,4).join(""),2)+1,e.colorTableSorted=!!n[4];const o=parseInt(n.slice(5,8).join(""),2);e.colorTableSize=Math.pow(2,o+1),e.backgroundColorIndex=t.readByte(),e.pixelAspectRatio=t.readByte(),e.globalColorTable&&(e.colorTableSize?e.colorTable=t.readColorTable(e.colorTableSize):t.readSubBlock()),e.frames=[];let i=r();const s=[],d=[];for(;;){const l=t.readByte();if(s.push(l),l===44){i.left=t.readUnsigned(),i.top=t.readUnsigned(),i.width=t.readUnsigned(),i.height=t.readUnsigned();const f=t.readBits();i.localColorTable=!!f[0],i.interlaced=!!f[1],i.colorTableSorted=!!f[2],i.reserved=parseInt(f.slice(3,5).join(""),2);const u=parseInt(f.slice(5,8).join(""),2);for(i.colorTableSize=Math.pow(2,u+1),i.localColorTable&&(i.colorTable=t.readColorTable(i.colorTableSize)),i.lzwMinCodeSize=t.readByte(),i.dataPositions=[];;){const g=t.readByte();if(g===0)break;const w=t.offset;i.dataPositions.push([w,g]),t.offset=w+g}e.frames.push(i),i=r(),i.index=e.frames.length;continue}if(l===33){const f=t.readByte();if(d.push(f),f===255){if(t.readByte()!==11)continue;const u={identifier:t.readString(8),code:t.readString(3),data:[]};`${u.identifier}${u.code}`=="NETSCAPE2.0"&&t.readByte()===3&&(e.looped=!!t.readByte(),e.loopCount=t.readUnsigned()),u.data=t.readSubBlock(),i.application=u;continue}if(f===254){i.comment=t.readSubBlock().map(u=>String.fromCharCode(u)).join("");continue}if(f===249){if(t.readByte()!==4)continue;const u=t.readBits(),g={reserved:parseInt(u.slice(0,3).join(""),2),disposal:parseInt(u.slice(3,6).join(""),2),userInput:!!u[6],transparent:!!u[7],delayTime:t.readUnsigned(),transparentIndex:t.readByte()};t.readSubBlock(),i.graphicControl=g,i.disposal=g.disposal,i.delay=(g.delayTime||10)*10;continue}if(f===1){if(t.readByte()!==1)continue;i.plainText={left:t.readUnsigned(),top:t.readUnsigned(),width:t.readUnsigned(),height:t.readUnsigned(),cellWidth:t.readByte(),cellHeight:t.readByte(),colorIndex:t.readByte(),backgroundColorIndex:t.readByte(),data:t.readSubBlock()};continue}console.warn(`Unknown extension block: 0x${f.toString(16)}`,s.slice(0,s.length-1).map(u=>`0x${u.toString(16)}`),d.slice(0,d.length-1).map(u=>`0x${u.toString(16)}`));continue}if(l===59)break;console.warn(`Unknown block: 0x${l.toString(16)}`,s.slice(0,s.length-1).map(f=>`0x${f.toString(16)}`),d.slice(0,d.length-1).map(f=>`0x${f.toString(16)}`))}return e}function Ee(h,e,t){const c=t;let n,o,i,s,d,l,f;const u=new Array(t),g=new Array(4096),w=new Array(4096),b=new Array(4096+1),y=h,I=1<<y,T=I+1;for(n=I+2,d=-1,i=y+1,o=(1<<i)-1,l=0;l<I;l++)g[l]=0,w[l]=l;let m,p,x,B,L,F;for(m=p=x=B=L=F=0,f=0;f<c;){if(B===0){if(p<i){m+=e[F]<<p,p+=8,F++;continue}if(l=m&o,m>>=i,p-=i,l>n||l===T)break;if(l===I){i=y+1,o=(1<<i)-1,n=I+2,d=-1;continue}if(d===-1){b[B++]=w[l],d=l,x=l;continue}for(s=l,l===n&&(b[B++]=x,l=d);l>I;)b[B++]=w[l],l=g[l];x=w[l]&255,b[B++]=x,n<4096&&(g[n]=d,w[n]=x,n++,!(n&o)&&n<4096&&(i++,o+=n)),d=s}B--,u[L++]=b[B],f++}for(f=L;f<c;f++)u[f]=0;return u}function Be(h,e){const t=new Array(h.length),r=h.length/e,a=[0,4,2,1],c=[8,8,4,2];let n=0;for(let o=0;o<4;o++)for(let i=a[o];i<r;i+=c[o])t.splice.apply(t,[i*e,e].concat(h.slice(n*e,(n+1)*e))),n++;return t}function de(h){const e=new Map,{workerUrl:t}=h;let{workerNumber:r=1}=h;const a=[...new Array(t?r:0)].map(()=>{try{const i=new Worker(t);return i.onmessage=c,i}catch(i){return null}}).filter(Boolean);r=a.length;function c(i){var l;const{id:s,data:d}=i.data;(l=e.get(s))==null||l(d),e.delete(s)}const n=function(){let i=0;return s=>a[(s!=null?s:i++)%r]}();return{call:function(){let i=0;return(s,d,l,f)=>new Promise(u=>{const g=n(f);if(!g)return u(void 0);e.set(i,u),g.postMessage({id:i++,type:s,data:d},{transfer:l})})}()}}function Ae(h,e){const t=j(h,"uint8Array");if(e!=null&&e.workerUrl)return de({workerUrl:e.workerUrl}).call("frames:decode",t,[t.buffer]);const{gif:r=Te(h),range:a}=e!=null?e:{},{width:c,height:n,colorTable:o,frames:i}=r,s=a?i.slice(a[0],a[1]+1):i,d=s.some(g=>g.disposal===3);let l=new Uint8ClampedArray(c*n*4),f,u=l.slice();return s.map(g=>{var _e;const{left:w,top:b,width:y,height:I,interlaced:T,localColorTable:m,colorTable:p,lzwMinCodeSize:x,dataPositions:B,graphicControl:L,delay:F,disposal:me}=g,re=f==null?void 0:f.disposal,ze=b+I,{transparent:Fe,transparentIndex:We}=L!=null?L:{},ne=m?p:o,He=Fe?We:-1,Ke=he(B.map(([O,X])=>t.subarray(O,O+X)));let ie=Ee(x,Ke,y*I);if(T&&(ie=Be(ie,y)),re===3)l=u.slice();else if(re===2){const{left:O,top:X,width:se,height:$}=f,V=X+$;for(let A=X;A<V;A++){const oe=A*c+O;for(let W=0;W<se;W++){const D=(oe+W)*4;l[D]=l[D+1]=l[D+2]=l[D+3]=0}}}for(let O=b;O<ze;O++){const X=O*c+w,se=(O-b)*y;for(let $=0;$<y;$++){const V=ie[se+$],A=(X+$)*4;if(V!==He){const[oe,W,D]=(_e=ne==null?void 0:ne[V])!=null?_e:[0,0,0];l[A]=oe,l[A+1]=W,l[A+2]=D,l[A+3]=255}else re===2&&(l[A]=l[A+1]=l[A+2]=l[A+3]=0)}}return d&&me!==1&&me!==3&&(u=l.slice()),f=g,{width:c,height:n,delay:F,data:l.slice()}})}const ke=typeof window<"u",_=65536-1,P=_*_,Ne=512-1,Q=[0,20,40,60,80,99,119,139,159,179,199,219,241,264,288,313,340,367,396,427,458,491,526,562,599,637,677,718,761,805,851,898,947,997,1048,1101,1156,1212,1270,1330,1391,1453,1517,1583,1651,1720,1790,1863,1937,2013,2090,2170,2250,2333,2418,2504,2592,2681,2773,2866,2961,3058,3157,3258,3360,3464,3570,3678,3788,3900,4014,4129,4247,4366,4488,4611,4736,4864,4993,5124,5257,5392,5530,5669,5810,5953,6099,6246,6395,6547,6700,6856,7014,7174,7335,7500,7666,7834,8004,8177,8352,8528,8708,8889,9072,9258,9445,9635,9828,10022,10219,10417,10619,10822,11028,11235,11446,11658,11873,12090,12309,12530,12754,12980,13209,13440,13673,13909,14146,14387,14629,14874,15122,15371,15623,15878,16135,16394,16656,16920,17187,17456,17727,18001,18277,18556,18837,19121,19407,19696,19987,20281,20577,20876,21177,21481,21787,22096,22407,22721,23038,23357,23678,24002,24329,24658,24990,25325,25662,26001,26344,26688,27036,27386,27739,28094,28452,28813,29176,29542,29911,30282,30656,31033,31412,31794,32179,32567,32957,33350,33745,34143,34544,34948,35355,35764,36176,36591,37008,37429,37852,38278,38706,39138,39572,40009,40449,40891,41337,41785,42236,42690,43147,43606,44069,44534,45002,45473,45947,46423,46903,47385,47871,48359,48850,49344,49841,50341,50844,51349,51858,52369,52884,53401,53921,54445,54971,55500,56032,56567,57105,57646,58190,58737,59287,59840,60396,60955,61517,62082,62650,63221,63795,64372,64952,65535],fe=[0,6,13,18,22,25,28,31,34,36,38,40,42,44,46,48,50,51,53,54,56,57,59,60,61,62,64,65,66,67,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,86,87,88,89,90,91,91,92,93,94,95,95,96,97,98,98,99,100,101,101,102,103,103,104,105,106,106,107,108,108,109,110,110,111,111,112,113,113,114,115,115,116,116,117,118,118,119,119,120,121,121,122,122,123,123,124,125,125,126,126,127,127,128,128,129,129,130,130,131,132,132,133,133,134,134,135,135,136,136,137,137,138,138,139,139,140,140,140,141,141,142,142,143,143,144,144,145,145,146,146,147,147,147,148,148,149,149,150,150,151,151,151,152,152,153,153,154,154,154,155,155,156,156,156,157,157,158,158,159,159,159,160,160,161,161,161,162,162,163,163,163,164,164,165,165,165,166,166,166,167,167,168,168,168,169,169,169,170,170,171,171,171,172,172,172,173,173,174,174,174,175,175,175,176,176,176,177,177,177,178,178,179,179,179,180,180,180,181,181,181,182,182,182,183,183,183,184,184,184,185,185,185,186,186,186,187,187,187,188,188,188,189,189,189,190,190,190,191,191,191,192,192,192,193,193,193,193,194,194,194,195,195,195,196,196,196,197,197,197,198,198,198,198,199,199,199,200,200,200,201,201,201,201,202,202,202,203,203,203,204,204,204,204,205,205,205,206,206,206,206,207,207,207,208,208,208,208,209,209,209,210,210,210,210,211,211,211,212,212,212,212,213,213,213,214,214,214,214,215,215,215,215,216,216,216,217,217,217,217,218,218,218,218,219,219,219,220,220,220,220,221,221,221,221,222,222,222,222,223,223,223,224,224,224,224,225,225,225,225,226,226,226,226,227,227,227,227,228,228,228,228,229,229,229,229,230,230,230,230,231,231,231,231,232,232,232,232,233,233,233,233,234,234,234,234,235,235,235,235,236,236,236,236,237,237,237,237,238,238,238,238,239,239,239,239,239,240,240,240,240,241,241,241,241,242,242,242,242,243,243,243,243,243,244,244,244,244,245,245,245,245,246,246,246,246,246,247,247,247,247,248,248,248,248,249,249,249,249,249,250,250,250,250,251,251,251,251,251,252,252,252,252,253,253,253,253,253,254,254,254,254,255,255,255];function J(h){let e;if(h<=0)return 0;if(h>=_)return _;e=h*(h*(h+-144107)/_+132114)/_+14379;for(let t=0;t<2;t++){const r=e*e*e,a=h+(2*r+P/2)/P;e=(e*(2*h+(r+P/2)/P)+a/2)/a}return e}function N(h,e){return(h^e)<0?(h-e/2)/e:(h+e/2)/e}function ue(h,e,t,r,a=!0,c=[255,255,255]){if(!a){r/=255;const n=1-r;h=h*r+n*c[0]&255,e=e*r+n*c[1]&255,t=t*r+n*c[2]&255}return{r:h,g:e,b:t}}function Y(h,e,t){return h<<16|e<<8|t}function ge(h,e,t){h=Q[h],e=Q[e],t=Q[t];const r=(27015*h+35149*e+3372*t+_/2)/_,a=(13887*h+44610*e+7038*t+_/2)/_,c=(5787*h+18462*e+41286*t+_/2)/_,n=J(r),o=J(a),i=J(c);return{l:N(13792*n+52010*o-267*i,_),a:N(129628*n-159158*o+29530*i,_),b:N(1698*n+51299*o-52997*i,_)}}function ee(h){if(h<=0)return 0;if(h>=_)return 255;{const e=h*Ne,t=~~(e/_),r=e%_,a=fe[t],c=fe[t+1];return(r*(c-a)+_/2)/_+a}}function Oe(h){const e=h.l+N(25974*h.a,_)+N(14143*h.b,_),t=h.l+N(-6918*h.a,_)+N(-4185*h.b,_),r=h.l+N(-5864*h.a,_)+N(-84638*h.b,_),a=k(e,3)/P,c=k(t,3)/P,n=k(r,3)/P,o=~~ee((267169*a+-216771*c+15137*n+_/2)/_),i=~~ee((-83127*a+171030*c+-22368*n+_/2)/_),s=~~ee((-275*a+-46099*c+111909*n+_/2)/_);return{r:o,g:i,b:s}}function Ue(h){return new Promise(e=>{const t=new Image;t.decoding="sync",t.loading="eager",t.crossOrigin="anonymous",t.onload=()=>e(t),t.onerror=()=>e(t),t.src=h})}class Z{constructor(){this.readable=new ReadableStream({start:e=>this._rsControler=e}),this.writable=new WritableStream({write:e=>H(this,null,function*(){var r,a,c,n;let t;switch(typeof e){case"string":{const o=yield Ue(e),i=Z.ctx2d,s=i.canvas;i.clearRect(0,0,s.width,s.height),s.width=o.width,s.height=o.height,i.drawImage(o,0,0,s.width,s.height),t=i.getImageData(0,0,s.width,s.height).data;break}default:if(ArrayBuffer.isView(e))t=new Uint8ClampedArray(e.buffer);else if(e instanceof ArrayBuffer)t=new Uint8ClampedArray(e);else if(Array.isArray(e))if(Array.isArray(e[0])){const o=[];for(let i=e.length,s=0;s<i;s++)o.push((r=e[s][0])!=null?r:0,(a=e[s][1])!=null?a:0,(c=e[s][2])!=null?c:0,(n=e[s][3])!=null?n:255);t=new Uint8ClampedArray(o)}else t=new Uint8ClampedArray(e);else{const o=Z.ctx2d,i=o.canvas;o.clearRect(0,0,i.width,i.height),i.width=typeof e.width=="number"?e.width:e.width.baseVal.value,i.height=typeof e.height=="number"?e.height:e.height.baseVal.value,o.drawImage(e,0,0,i.width,i.height),t=o.getImageData(0,0,i.width,i.height).data}break}this._rsControler.enqueue(t)}),close:()=>{this._rsControler.close()}})}static get ctx2d(){if(!this._ctx2d){if(!ke)throw new Error("Failed to get ImageToPixels.ctx2d, not in browser.");const e=document.createElement("canvas").getContext("2d",{willReadFrequently:!0});if(!e)throw new Error("Failed to get ImageToPixels.ctx2d, getContext('2d') return null.");this._ctx2d=e}return this._ctx2d}}class te{constructor(e){this.maxColors=e,this.readable=new ReadableStream({start:t=>this._rsControler=t}),this.writable=new WritableStream({write:t=>{this._rsControler.enqueue(this._boxesToQuantizedColors(this._colorsToBoxes(t)))},close:()=>{this._rsControler.close()}})}static createSorter(e){const t=e[0],r=e[1],a=e[2];return(c,n)=>c.lab[t]-n.lab[t]||c.lab[r]-n.lab[r]||c.lab[a]-n.lab[a]}_colorsToBoxes(e){let t={start:0,end:e.length-1,sorted:null,count:0,score:0,weight:0,sort:"lab",avg:{l:0,a:0,b:0}};const r=[t];let a=1;const c=(s,d,l)=>s>=d?d>=l?"lab":s>=l?"lba":"bla":s>=l?"alb":d>=l?"abl":"bal",n=s=>{const{start:d,end:l}=s;s.count=l-d+1,s.weight=0;const f={l:0,a:0,b:0};for(let g=d;g<=l;g++){const w=e[g];f.l+=w.lab.l*w.count,f.a+=w.lab.a*w.count,f.b+=w.lab.b*w.count,s.weight+=w.count}s.avg.l=f.l/s.weight,s.avg.a=f.a/s.weight,s.avg.b=f.b/s.weight;const u={l:0,a:0,b:0};for(let g=d;g<=l;g++){const w=e[g];u.l+=k(w.lab.l-s.avg.l,2)*w.count,u.a+=k(w.lab.a-s.avg.a,2)*w.count,u.b+=k(w.lab.b-s.avg.b,2)*w.count}s.sort=c(u.l,u.a,u.b),s.score=Math.max(u.l,u.a,u.b)},o=(s,d)=>{const l={start:d+1,end:s.end,sorted:s.sorted,count:0,score:0,weight:0,sort:"lab",avg:{l:0,a:0,b:0}};n(l),s.end-=l.count,n(s),r.push(l),a++},i=()=>{let s=-1,d=-1;if(a===this.maxColors)return-1;for(let l=0;l<a;l++){const f=r[l];f.count>=2&&f.score>d&&(s=l,d=f.score)}return s};for(n(t);t&&t.count>1;){const{start:s,end:d,sort:l,sorted:f}=t;if(l!==f){const y=e.slice(s,d+1).sort(te.createSorter(l));for(let I=y.length,T=0;T<I;T++)e[s+T]=y[T];t.sorted=l}const u=t.weight+1>>1;let g=s,w=0;for(;g<d-1&&(w+=e[g].count,!(w>u));g++);o(t,g);const b=i();t=b>=0?r[b]:null}return r}_boxesToQuantizedColors(e){const t=e.reduce((r,a)=>r+a.weight,0);return e.map(r=>{const{r:a,g:c,b:n}=Oe(r.avg);return{rgbInt:Y(a,c,n),rgb:{r:a,g:c,b:n},hex:`#${a.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}`,lab:r.avg,count:r.weight,percentage:r.weight/t}}).sort((r,a)=>r.rgbInt-a.rgbInt)}}class ve{constructor(e,t,r){this.statsMode=e,this.premultipliedAlpha=t,this.tint=r,this._colors=[],this._cache=new Map,this.readable=new ReadableStream({start:a=>this._rsControler=a}),this.writable=new WritableStream({write:a=>{for(let c=a.length,n=0;n<c;n+=4){let o=a[n],i=a[n+1],s=a[n+2];const d=a[n+3];if(this.statsMode==="diff"&&this._previousPixels&&o===this._previousPixels[n]&&i===this._previousPixels[n+1]&&s===this._previousPixels[n+2]&&d===this._previousPixels[n+3])continue;({r:o,g:i,b:s}=ue(o,i,s,d,this.premultipliedAlpha,this.tint));const l=Y(o,i,s),f={rgbInt:l,lab:ge(o,i,s),count:1},u=l%32768;let g=this._cache.get(u);g||this._cache.set(u,g=new Map);let w=g.get(l);if(w!==void 0){this._colors[w].count++;continue}w=this._colors.push(f)-1,g.set(l,w)}this.statsMode==="diff"&&(this._previousPixels=a)},close:()=>{this._rsControler.enqueue(this._colors.slice()),this._rsControler.close(),this._colors.length=0,this._cache.clear(),this._previousPixels=void 0}})}}class we{constructor(e=[],t=!1,r=[255,255,255]){this._premultipliedAlpha=t,this._tint=r,this._cache=new Map,this._colorMap=[],e.length&&this.setup(e)}setup(e){e=e.sort((n,o)=>n.rgbInt-o.rgbInt),this._cache.clear();const t=[],r=new Map;for(let n=-1,o=e.length,i=0;i<o;i++){const{rgbInt:s}=e[i];if(s===n){r.set(i,!0);continue}n=s}c({min:[-65535,-65535,-65535],max:[65535,65535,65535]}),this._colorMap=t;function a(n){const o={min:[65535,65535,65535],max:[-65535,-65535,-65535]},i=[];for(let g=e.length,w=0;w<g;w++){const{lab:b}=e[w];r.has(w)||b.l<n.min[0]||b.a<n.min[1]||b.b<n.min[2]||b.l>n.max[0]||b.a>n.max[1]||b.b>n.max[2]||(b.l<o.min[0]&&(o.min[0]=b.l),b.a<o.min[1]&&(o.min[1]=b.a),b.b<o.min[2]&&(o.min[2]=b.b),b.l>o.max[0]&&(o.max[0]=b.l),b.a>o.max[1]&&(o.max[1]=b.a),b.b>o.max[2]&&(o.max[2]=b.b),i.push({lab:b,index:w}))}let s="l",d=0;if(!i.length)return{index:-1,longest:s,longestIndex:d};const l=o.max[0]-o.min[0],f=o.max[1]-o.min[1],u=o.max[2]-o.min[2];return u>=l&&u>=f&&(s="b",d=2),f>=l&&f>=u&&(s="a",d=1),l>=f&&l>=u&&(s="l",d=0),{index:i.sort((g,w)=>g.lab[s]-w.lab[s])[i.length>>1].index,longest:s,longestIndex:d}}function c(n){const{index:o,longest:i,longestIndex:s}=a(n);if(o<0)return-1;r.set(o,!0);const{lab:d}=e[o],l={left:0,right:0,longest:i,lab:d,index:o},f=t.push(l)-1,u={max:[...n.max],min:[...n.min]},g={max:[...n.max],min:[...n.min]};u.max[s]=d[i],g.min[s]=Math.min(d[i]+1,65535);const w=c(u);let b=-1;return g.min[s]<=g.max[s]&&(b=c(g)),l.left=w,l.right=b,f}}_colormapNearestNode(e,t,r){const{left:a,right:c,longest:n,lab:o,index:i}=this._colorMap[e],s=Math.min(k(t.l-o.l,2)+k(t.a-o.a,2)+k(t.b-o.b,2),4294967295-1);s<r.dist&&(r.index=i,r.dist=s);let d,l;if(a!==-1||c!==-1){const f=t[n]-o[n];f<=0?(d=a,l=c):(d=c,l=a),d!==-1&&this._colormapNearestNode(d,t,r),l!==-1&&k(f,2)<r.dist&&this._colormapNearestNode(l,t,r)}}findNearestIndex(e,t,r,a=255){({r:e,g:t,b:r}=ue(e,t,r,a,this._premultipliedAlpha,this._tint));const c=Y(e,t,r),n=c%32768;let o=this._cache.get(n);o||this._cache.set(n,o=new Map);let i=o.get(c);if(i!==void 0)return i;const s={dist:Number.MAX_SAFE_INTEGER,index:-1};return this._colormapNearestNode(0,ge(e,t,r),s),i=s.index,o.set(c,i),i}}class Re{constructor(e={}){this.colors=[],this.config=this._resolveOptions(e),this._stream=this._createStream()}_resolveOptions(e){const{maxColors:t=256,statsMode:r="full",algorithm:a="median-cut",premultipliedAlpha:c=!1,tint:n=[255,255,255],samples:o=[]}=e;return{maxColors:t,statsMode:r,algorithm:a,premultipliedAlpha:c,tint:n,samples:o}}_createStream(){let e;switch(this.config.algorithm){case"median-cut":default:e=new te(this.config.maxColors);break}return new ReadableStream({start:t=>{this._streamControler=t,this.config.samples.forEach(r=>t.enqueue(r))}}).pipeThrough(new Z).pipeThrough(new ve(this.config.statsMode,this.config.premultipliedAlpha,this.config.tint)).pipeThrough(e)}addSample(e){this._streamControler.enqueue(e)}generate(){return new Promise(e=>{this._streamControler.close(),this._stream.pipeTo(new WritableStream({write:t=>{this.colors=t,this.finder=new we(t,this.config.premultipliedAlpha,this.config.tint),this._stream=this._createStream(),e(t)}}))})}match(e){var t;let r;if(typeof e=="number")r=[e>>24&255,e>>16&255,e>>8&255,e&255];else if(typeof e=="string"){const n=e.replace(/^#/,"");r=[`${n[0]}${n[1]}`,`${n[2]}${n[3]}`,`${n[4]}${n[5]}`].map(o=>parseInt(o,16))}else if(Array.isArray(e))r=e;else throw new TypeError("Unsupported color format");const a=(t=this.finder)==null?void 0:t.findNearestIndex(r[0],r[1],r[2],r[3]);if(a===void 0||a<0)return;const c=this.colors[a];if(c)return{color:c,index:a}}toColors(){return this.colors.slice()}toHexColors(){return this.colors.map(e=>e.hex)}toRgbColors(){return this.colors.map(e=>e.rgb)}toRgbIntColors(){return this.colors.map(e=>e.rgbInt)}toLabColors(){return this.colors.map(e=>e.lab)}toUint8Array(e=this.colors.length*4){var c;var t;let r;const a=new Uint8ClampedArray(e);for(let n=0;n<e;n++){const o=n*4,i=(c=(t=this.colors[n])==null?void 0:t.rgb)!=null?c:r;i&&(a[o]=i.r,a[o+1]=i.g,a[o+2]=i.b,a[o+3]=255,r=i)}return a}clear(){this.colors.length=0,this._stream=this._createStream()}}const z=class{constructor(h=!0){this.isDebug=h}time(h){this.isDebug&&console.time(`${z.prefix} ${h}`)}timeEnd(h){this.isDebug&&console.timeEnd(`${z.prefix} ${h}`)}debug(...h){this.isDebug&&console.debug(z.prefix,...h)}warn(...h){this.isDebug&&console.warn(z.prefix,...h)}};let be=z;be.prefix="[modern-gif]";class Pe{constructor(e){this._config=e,this._frames=[],this.readable=new ReadableStream({start:t=>this._rsControler=t}),this.writable=new WritableStream({write:t=>{this._frames.push(t)},close:()=>{const t=this._config.backgroundColorIndex;let r;this._frames.forEach((a,c)=>{var I,T;const{width:n=1,height:o=1,data:i}=a,s=a.transparent||((T=(I=this._frames[c+1])==null?void 0:I.transparent)!=null?T:!0);let d=0,l=0,f=n-1,u=o-1,g;if(s){for(;l<u;){let m=!0;for(let p=0;p<n;p++)if(i[n*l+p]!==t){m=!1;break}if(!m)break;l++}for(;u>l;){let m=!0;for(let p=0;p<n;p++)if(i[n*u+p]!==t){m=!1;break}if(!m)break;u--}for(;d<f;){let m=!0;for(let p=l;p<u;p++)if(i[n*p+d]!==t){m=!1;break}if(!m)break;d++}for(;f>d;){let m=!0;for(let p=l;p<u;p++)if(i[n*p+f]!==t){m=!1;break}if(!m)break;f--}}else{if(r){for(;l<u;){let m=!0;for(let p=0;p<n;p++){const x=n*l+p;if(i[x]!==r[x]){m=!1;break}}if(!m)break;l++}for(;u>l;){let m=!0;for(let p=0;p<n;p++){const x=n*u+p;if(i[x]!==r[x]){m=!1;break}}if(!m)break;u--}if(l===u)d=f;else{for(;d<f;){let m=!0;for(let p=l;p<=u;p++){const x=p*n+d;if(i[x]!==r[x]){m=!1;break}}if(!m)break;d++}for(;f>d;){let m=!0;for(let p=l;p<=u;p++){const x=p*n+f;if(i[x]!==r[x]){m=!1;break}}if(!m)break;f--}}}g=r,r=i}const w=f+1-d,b=u+1-l,y=new Uint8ClampedArray(w*b);for(let m=0;m<b;m++)for(let p=0;p<w;p++){const x=m*w+p,B=(l+m)*n+(d+p);if(!s&&g&&i[B]===g[B]){y[x]=t;continue}y[x]=i[B]}this._rsControler.enqueue(R(U({},a),{left:d,top:l,width:w,height:b,disposal:s?2:1,data:y,graphicControl:R(U({},a.graphicControl),{transparent:!0,transparentIndex:t})}))}),this._rsControler.close()}})}}class pe{constructor(e=4096){this._chunkByteLength=e,this._chunkIndex=0,this._chunkOffset=0,this._chunks=[this._createChunk()]}get cursor(){return[this._chunkIndex,this._chunkOffset]}_createChunk(){return new DataView(new ArrayBuffer(this._chunkByteLength))}writeByte(e,t){t?this._chunks[t[0]].setUint8(t[1],e):(this._chunkOffset>=this._chunkByteLength&&(this._chunks[++this._chunkIndex]=this._createChunk(),this._chunkOffset=0),this._chunks[this._chunkIndex].setUint8(this._chunkOffset++,e))}writeBytes(e){e.forEach(t=>this.writeByte(t))}writeString(e){e.split("").forEach(t=>{this.writeByte(t.charCodeAt(0))})}writeUnsigned(e){this.writeBytes([e&255,e>>8&255])}calculateDistance(e){return this._chunkIndex*this._chunkByteLength+this._chunkOffset-(e[0]*this._chunkByteLength+e[1])}toUint8Array(){this._chunks[this._chunkIndex]=new DataView(this._chunks[this._chunkIndex].buffer.slice(0,this._chunkOffset));const e=new Uint8Array(this._chunks.reduce((r,a)=>r+a.byteLength,0));let t=0;return this._chunks.forEach(r=>{e.set(new Uint8Array(r.buffer),t),t+=r.byteLength}),this._chunks=[this._createChunk()],this._chunkIndex=0,this._chunkOffset=0,e}}class Me{constructor(e){this._config=e,this._frames=[],this.readable=new ReadableStream({start:t=>this._rsControler=t}),this.writable=new WritableStream({write:t=>{this._frames.push(t)},close:()=>{const t=this._encodeHeader(),r=he(this._frames),a=new Uint8Array(t.length+r.byteLength+1);a.set(t),a.set(r,t.byteLength),a[a.length-1]=59,this._rsControler.enqueue(a),this._rsControler.close(),this._frames.length=0}})}_encodeHeader(){var a,c,n;const e=U({version:"89a",looped:!0,loopCount:0,pixelAspectRatio:0},this._config);if(e.width<=0||e.width>65535)throw new Error("Width invalid.");if(e.height<=0||e.height>65535)throw new Error("Height invalid.");let t=0;if((a=e.colorTable)!=null&&a.length){let o=e.colorTable.length;if(o<2||o>256||o&o-1)throw new Error("Invalid color table length, must be power of 2 and 2 .. 256.");for(;o>>=1;)++t;if(o=1<<t,e.colorTableSize=--t,e.backgroundColorIndex>=o)throw new Error("Background index out of range.");if(e.backgroundColorIndex===0)throw new Error("Background index explicitly passed as 0.")}const r=new pe;return r.writeString(E),r.writeString(e.version),r.writeUnsigned(e.width),r.writeUnsigned(e.height),r.writeByte(parseInt(`${e.colorTableSize?1:0}1110${e.colorTableSize.toString(2).padStart(3,"0")}`,2)),r.writeByte(e.backgroundColorIndex),r.writeByte(e.pixelAspectRatio),r.writeBytes((n=(c=e.colorTable)==null?void 0:c.flat())!=null?n:[]),e.looped&&(r.writeByte(33),r.writeByte(255),r.writeByte(11),r.writeString("NETSCAPE2.0"),r.writeByte(3),r.writeByte(1),r.writeUnsigned(e.loopCount),r.writeByte(0)),r.toUint8Array()}}class Le{constructor(e,t){this._config=e,this.readable=new ReadableStream({start:r=>this._rsControler=r}),this.writable=new WritableStream({write:r=>{const a=this._config.backgroundColorIndex,c=r.data;let n=!1;const o=new Uint8ClampedArray(c.length/4);for(let i=c.length,s=0;s<i;s+=4)c[s+3]===0?(o[s/4]=a,n=!0):o[s/4]=this._finder.findNearestIndex(c[s],c[s+1],c[s+2],c[s+3]);this._rsControler.enqueue(R(U({},r),{data:o,transparent:n}))},close:()=>{this._rsControler.close()}}),this._finder=new we(t,e.premultipliedAlpha,e.tint)}}function Xe(h,e,t){t.writeByte(h);let r=t.cursor;t.writeByte(0);const a=1<<h,c=a-1,n=a+1;let o=n+1,i=h+1,s=0,d=0;function l(I){for(;s>=I;)t.writeByte(d&255),d>>=8,s-=8,t.calculateDistance(r)===256&&(t.writeByte(255,r),r=t.cursor,t.writeByte(0))}function f(I){d|=I<<s,s+=i,l(8)}let u=e[0]&c,g={},w,b,y;f(a);for(let I=e.length,T=1;T<I;++T)if(y=e[T]&c,w=u<<8|y,b=g[w],b===void 0){for(d|=u<<s,s+=i;s>=8;)t.writeByte(d&255),d>>=8,s-=8,t.calculateDistance(r)===256&&(t.writeByte(255,r),r=t.cursor,t.writeByte(0));o===4096?(f(a),o=n+1,i=h+1,g={}):(o>=1<<i&&++i,g[w]=o++),u=y}else u=b;f(u),f(n),l(1),t.calculateDistance(r)===1?t.writeByte(0,r):(t.writeByte(t.calculateDistance(r)-1,r),t.writeByte(0))}class $e{constructor(e){this._config=e,this.readable=new ReadableStream({start:t=>this._rsControler=t}),this.writable=new WritableStream({write:t=>{var w,b,y;const r=new pe,{left:a=0,top:c=0,width:n=0,height:o=0,delay:i=100,colorTable:s}=t;let{disposal:d=0}=t;const l=(w=t.graphicControl)==null?void 0:w.transparent;let f=(y=(b=t.graphicControl)==null?void 0:b.transparentIndex)!=null?y:255;if(a<0||a>65535)throw new Error("Left invalid.");if(c<0||c>65535)throw new Error("Top invalid.");if(n<=0||n>65535)throw new Error("Width invalid.");if(o<=0||o>65535)throw new Error("Height invalid.");let u=8,g=s?s.length:0;if(g){if(g<2||g>256||g&g-1)throw new Error("Invalid color table length, must be power of 2 and 2 .. 256.");for(;g>>=1;)++u}r.writeByte(33),r.writeByte(249),r.writeByte(4),l?d||(d=2):f=0,r.writeByte(parseInt(`000${Number(d&7).toString(2).padStart(3,"0")}0${l?1:0}`,2)),r.writeUnsigned(i/10),r.writeByte(f),r.writeByte(0),r.writeByte(44),r.writeUnsigned(a),r.writeUnsigned(c),r.writeUnsigned(n),r.writeUnsigned(o),s!=null&&s.length?(r.writeByte(parseInt(`10000${(u-1).toString(2).padStart(3,"0")}`,2)),r.writeBytes(s.flat())):r.writeByte(0),Xe(u,t.data,r),this._rsControler.enqueue(r.toUint8Array())},close:()=>this._rsControler.close()})}}class De{constructor(e){var t;this._encodingFrames=[],this._encodeUUID=0,this._logger=new be(!!e.debug),this._config=this._resolveOptions(e),this._palette=new Re({maxColors:this._config.maxColors,premultipliedAlpha:this._config.premultipliedAlpha,tint:this._config.tint}),this._config.workerUrl?(this._worker=de({workerUrl:this._config.workerUrl}),this._worker.call("encoder:init",e)):(t=this._config.frames)==null||t.forEach(r=>this.encode(r))}_resolveOptions(e){["width","height"].forEach(o=>{typeof e[o]!="undefined"&&Math.floor(e[o])!==e[o]&&(console.warn(`${o} cannot be a floating point number`),e[o]=Math.floor(e[o]))});const{colorTableSize:t=256,backgroundColorIndex:r=t-1,maxColors:a=t-1,premultipliedAlpha:c=!1,tint:n=[255,255,255]}=e;return R(U({},e),{colorTableSize:t,backgroundColorIndex:r,maxColors:a,premultipliedAlpha:c,tint:n})}encode(e){return H(this,null,function*(){if(this._worker){let n;return ArrayBuffer.isView(e.data)?n=[e.data.buffer]:e.data instanceof ArrayBuffer&&(n=[e.data]),this._worker.call("encoder:encode",e,n)}const t=this._encodeUUID;this._encodeUUID++;const{width:r=this._config.width,height:a=this._config.height}=e;let{data:c}=e;try{this._logger.time(`palette:sample-${t}`),c=typeof c=="string"?yield Ce(c):c,c=j(c,"uint8ClampedArray",{width:r,height:a}),this._encodingFrames.push(R(U({},e),{width:r,height:a,data:c})),this._palette.addSample(c)}finally{this._logger.timeEnd(`palette:sample-${t}`)}})}flush(e){return H(this,null,function*(){if(this._worker)return this._worker.call("encoder:flush",e);this._logger.time("palette:generate");const t=yield this._palette.generate();this._logger.timeEnd("palette:generate");const r=t.map(c=>[c.rgb.r,c.rgb.g,c.rgb.b]);for(;r.length<this._config.colorTableSize;)r.push([0,0,0]);this._logger.debug("palette:maxColors",this._config.maxColors),this._logger.isDebug&&console.debug(t.map(()=>"%c ").join(""),...t.map(c=>`margin: 1px; background: ${c.hex}`)),this._logger.time("encode");const a=yield new Promise(c=>{new ReadableStream({start:n=>{this._encodingFrames.forEach(o=>{n.enqueue(o)}),n.close()}}).pipeThrough(new Le(this._config,t)).pipeThrough(new Pe(this._config)).pipeThrough(new $e(this._config)).pipeThrough(new Me(R(U({},this._config),{colorTable:r}))).pipeTo(new WritableStream({write:n=>c(n)}))});switch(this._logger.timeEnd("encode"),this._encodingFrames=[],this._encodeUUID=0,e){case"blob":return new Blob([a.buffer],{type:"image/gif"});case"arrayBuffer":default:return a.buffer}})}}let M;self.onmessage=h=>H(this,null,function*(){const{id:e,type:t,data:r}=h.data;switch(t){case"encoder:init":return M=new De(R(U({},r),{workerUrl:void 0})),self.postMessage({id:e,type:t,data:!0});case"encoder:encode":return self.postMessage({id:e,type:t,data:yield M==null?void 0:M.encode(r)});case"encoder:flush":return self.postMessage({id:e,type:t,data:yield M==null?void 0:M.flush(r)});case"frames:decode":{const a=Ae(r);return self.postMessage({id:e,type:t,data:a},a.map(c=>c.data.buffer))}}})})();
