import{a as M,t as F}from"./disclose-version.Bo9HnLYn.js";import{k as X,w as B,o as I,G as D,n as C,t as Y,b as x,l as Z,an as K,e as k,a4 as lt}from"./runtime.CQ81CuDx.js";import{e as L,d as tt}from"./render.DQGzWiBa.js";import{i as N}from"./if.Ogru3AK2.js";import{r as it,b as ct}from"./3.BEl6cISv.js";import{s as et,a as S,b as dt}from"./store.kYhZgm38.js";import{m as at,b as J,d as ut,c as vt,w as nt}from"./store.svelte.DBc1b8wm.js";import{c as ft,a as mt}from"./canvas.CVWb7qMF.js";import{s as V}from"./attributes.Bg6YOHw9.js";import{b as z}from"./this.CgtAJvLj.js";import{g as ht}from"./constants.CRYFBpvt.js";function st(i,t,s){if(s){if(i.classList.contains(t))return;i.classList.add(t)}else{if(!i.classList.contains(t))return;i.classList.remove(t)}}class bt{grayscale(t){for(let s=0;s<t.data.length;s+=4){const a=t.data[s]*.299+t.data[s+1]*.587+t.data[s+2]*.114;t.data.fill(a,s,s+3)}return t}threshold(t,s){for(let a=0;a<t.data.length;a+=4){const n=t.data[a]*.299+t.data[a+1]*.587+t.data[a+2]*.114<s?0:255;t.data.fill(n,a,a+3)}return t}bayer(t,s){const a=[[15,135,45,165],[195,75,225,105],[60,180,30,150],[240,120,210,90]];for(let e=0;e<t.data.length;e+=4){const n=t.data[e]*.299+t.data[e+1]*.587+t.data[e+2]*.114,o=e/4%t.width,r=Math.floor(e/4/t.width),c=Math.floor((n+a[o%4][r%4])/2)<s?0:255;t.data.fill(c,e,e+3)}return t}floydsteinberg(t){const s=t.width,a=new Uint8ClampedArray(t.width*t.height);for(let e=0,n=0;n<t.data.length;e++,n+=4)a[e]=t.data[n]*.299+t.data[n+1]*.587+t.data[n+2]*.114;for(let e=0,n=0;n<t.data.length;e++,n+=4){const o=a[e]<129?0:255,r=Math.floor((a[e]-o)/16);t.data.fill(o,n,n+3),a[e+1]+=r*7,a[e+s-1]+=r*3,a[e+s]+=r*5,a[e+s+1]+=r*1}return t}atkinson(t){const s=t.width,a=new Uint8ClampedArray(t.width*t.height);for(let e=0,n=0;n<t.data.length;e++,n+=4)a[e]=t.data[n]*.299+t.data[n+1]*.587+t.data[n+2]*.114;for(let e=0,n=0;n<t.data.length;e++,n+=4){const o=a[e]<129?0:255,r=Math.floor((a[e]-o)/8);t.data.fill(o,n,n+3),a[e+1]+=r,a[e+2]+=r,a[e+s-1]+=r,a[e+s]+=r,a[e+s+1]+=r,a[e+2*s]+=r}return t}}var pt=new bt;const gt=ht(pt);var Q=wt;function wt(i,t,s){var a=null,e=null,n=s&&s.leading,o=s&&s.trailing;n==null&&(n=!0),o==null&&(o=!n),n==!0&&(o=!1);var r=function(){a&&(clearTimeout(a),a=null)},b=function(){var d=e;r(),d&&d()},c=function(){var d=n&&!a,v=this,p=arguments;if(e=function(){return i.apply(v,p)},a||(a=setTimeout(function(){if(a=null,o)return e()},t)),d)return d=!1,e()};return c.cancel=r,c.flush=b,c}var _t=F('<span class="switch-camera-icon svelte-9mnb28">⟲</span>'),yt=F('<button type="button" class="stylized-webcam-feed svelte-9mnb28"><video class="raw-webcam sekrit svelte-9mnb28"></video> <canvas class="recording-webcam sekrit svelte-9mnb28"></canvas> <canvas class="display-webcam svelte-9mnb28"></canvas> <!></button>');function It(i,t){X(t,!0);const s=et(),a=()=>S(vt,"$colorPalette",s),e=()=>S(ut,"$cameras",s),n=()=>S(J,"$mediaDeviceId",s),o=200,r=150,b=o/r;let c,d,v,p=o,$=r,E,w=K("initial");function _(){const{videoWidth:l,videoHeight:u}=c,g=l/u;let h,y;g>b?(y=u,h=y*b):(h=l,y=h/b);const j=l/2-h/2,q=u/2-y/2;return{x:j,y:q,width:h,height:y}}function P(){const l=v.getContext("2d"),u=d.getContext("2d");if(!l||!u){console.error("Canvas contexts could not be initialized");return}const{x:g,y:h,width:y,height:j}=_();l.drawImage(c,g,h,y,j,0,0,p,$);const q=l.getImageData(0,0,p,$),O=gt.atkinson(q);u.putImageData(O,0,0),l.putImageData(O,0,0),ft(v,a())}const R=Q(P,100,{leading:!0});function G(){R(),E=requestAnimationFrame(G)}B(()=>{t.onMount({recordingCanvasElement:d})}),B(()=>{const l=at.subscribe(u=>{const{stream:g}=u;g&&(c.srcObject=null,c.srcObject=g,c.play(),cancelAnimationFrame(E),E=requestAnimationFrame(G))});return function(){cancelAnimationFrame(E),l()}});const f=Q(function(){setTimeout(()=>k(w,"playing"),250)},1e3);function m(){k(w,"suspended")}function U(){k(w,"waiting")}function rt(){if(e().length<=1)return;const l=n()?e().findIndex(h=>h.deviceId===n()):0,u=e().length-1>l?l+1:0,g=e()[u].deviceId;J.set(g)}var A=yt();A.__click=rt;var T=I(A);z(T,l=>c=l,()=>c),T.playsInline=!0;var W=D(T,2);z(W,l=>d=l,()=>d),V(W,"width",o),V(W,"height",r);var H=D(W,2);z(H,l=>v=l,()=>v),V(H,"width",o),V(H,"height",r);var ot=D(H,2);N(ot,()=>e().length>1,l=>{var u=_t();M(l,u)}),C(A),Y(()=>st(A,"playing",x(w)==="playing")),L("playing",T,f),L("suspend",T,m),L("waiting",T,U),M(i,A),Z()}tt(["click"]);function Ct(i,t){i.key==="Enter"&&!i.shiftKey&&t(i)}function xt(i,t){dt(nt,!0)}var Dt=F('<span class="recording-indicator svelte-5g9ad5"></span>'),kt=F('<div class="enable-webcam-message__container svelte-5g9ad5"><button class="dark enable-webcam-message svelte-5g9ad5"><em>Click</em> to enable your webcam and chat<em>!</em></button></div>'),Et=F('<div class="new-message svelte-5g9ad5"><form class="form svelte-5g9ad5"><div class="recording-booth svelte-5g9ad5"><!> <!> <div class="recording-progress svelte-5g9ad5"></div></div> <div class="fake-input svelte-5g9ad5"><textarea class="input svelte-5g9ad5" placeholder="Type to GIF"></textarea> <span class="fake-input__action svelte-5g9ad5"><button class="submit blend svelte-5g9ad5" type="submit">➪</button></span></div></form> <!></div>');function Lt(i,t){X(t,!0);const s=et(),a=()=>S(nt,"$webcamEnabled",s),e=()=>S(at,"$mediaStream",s);let n,o=K(""),r=K(!1);function b(f){n=f.recordingCanvasElement}async function c(f){f.preventDefault(),k(r,!0);const m=await mt(n);k(r,!1),t.onCreateMessage({text:x(o),imageDataBlob:m}),k(o,"")}var d=Et(),v=I(d),p=I(v),$=I(p);It($,{onMount:b});var E=D($,2);N(E,()=>x(r),f=>{var m=Dt();M(f,m)}),lt(2),C(p);var w=D(p,2),_=I(w);it(_),_.__keydown=[Ct,c];var P=D(_,2),R=I(P);C(P),C(w),C(v);var G=D(v,2);N(G,()=>!a(),f=>{var m=kt(),U=I(m);U.__click=[xt,a],C(m),M(f,m)}),C(d),Y(()=>{st(d,"recording",x(r)),_.disabled=!e()||x(r),R.disabled=!e()||x(r)}),L("submit",v,c),ct(_,()=>x(o),f=>k(o,f)),M(i,d),Z()}tt(["keydown","click"]);export{Lt as default};
